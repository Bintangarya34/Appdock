<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traefik Load Balancer Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .info-card p {
            color: #666;
            font-size: 0.9em;
            word-break: break-all;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .stats h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            background: #28a745;
            color: white;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9em;
            margin: 10px 0;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 0.9em;
        }

        .performance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .perf-card {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .perf-card .number {
            font-size: 1.5em;
            font-weight: bold;
            color: #1976d2;
        }

        .perf-card .label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Traefik Load Balancer Demo</h1>
        
        <div class="info-grid">
            <div class="info-card">
                <h3>üåê Access Points</h3>
                <p><strong>App:</strong> http://app.localhost</p>
                <p><strong>Traefik Dashboard:</strong> http://traefik.localhost:8080</p>
            </div>
            <div class="info-card">
                <h3>üìä Current Instance</h3>
                <p id="instance-info">Loading...</p>
            </div>
            <div class="info-card">
                <h3>‚ö° Status</h3>
                <p><span class="status">ONLINE</span></p>
            </div>
        </div>

        <div class="buttons">
            <button onclick="fetchData()">üîÑ Refresh Data</button>
            <button onclick="loadTest()">‚ö° Load Test</button>
            <button onclick="fetchStats()">üìä View Stats</button>
            <button onclick="resetStats()">üóëÔ∏è Reset Stats</button>
            <button onclick="window.open('http://traefik.localhost:8080', '_blank')">üéõÔ∏è Traefik Dashboard</button>
        </div>

        <div class="stats" id="stats">
            <h3>üìà Application Statistics</h3>
            <div class="loading">Click "Refresh Data" to load statistics...</div>
        </div>

        <div class="footer">
            <p>üê≥ Powered by Docker + Traefik + Node.js | Load balanced across multiple instances</p>
            <p>Refresh the page multiple times to see load balancing in action!</p>
        </div>
    </div>

    <script>
        let loadTestResults = [];

        async function fetchData() {
            try {
                const response = await fetch('/');
                const data = await response.json();
                
                document.getElementById('instance-info').innerHTML = `
                    <strong>Instance ${data.instanceId}</strong><br>
                    Session: ${data.sessionId.substring(0, 8)}...<br>
                    Request #${data.requestNumber}
                `;

                updateStats(data);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('stats').innerHTML = '<div class="error">Error loading data: ' + error.message + '</div>';
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                displayDetailedStats(data);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('stats').innerHTML = '<div class="error">Error loading stats: ' + error.message + '</div>';
            }
        }

        async function loadTest() {
            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Testing...';

            try {
                const startTime = Date.now();
                const response = await fetch('/api/load-test');
                const endTime = Date.now();
                const data = await response.json();

                loadTestResults.push({
                    instance: data.instanceId,
                    networkTime: endTime - startTime,
                    processingTime: data.processingTime,
                    timestamp: data.timestamp
                });

                displayLoadTestResults();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('stats').innerHTML = '<div class="error">Load test failed: ' + error.message + '</div>';
            } finally {
                button.disabled = false;
                button.textContent = '‚ö° Load Test';
            }
        }

        async function resetStats() {
            try {
                const response = await fetch('/api/reset', { method: 'POST' });
                const data = await response.json();
                loadTestResults = [];
                
                document.getElementById('stats').innerHTML = `
                    <h3>‚úÖ Stats Reset</h3>
                    <p>${data.message}</p>
                `;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('stats').innerHTML = '<div class="error">Reset failed: ' + error.message + '</div>';
            }
        }

        function updateStats(data) {
            let statsHtml = `
                <h3>üìä Current Request Data</h3>
                <div class="performance-stats">
                    <div class="perf-card">
                        <div class="number">Instance ${data.instanceId}</div>
                        <div class="label">Current Instance</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${data.requestNumber}</div>
                        <div class="label">Local Requests</div>
                    </div>
            `;

            if (data.stats) {
                statsHtml += `
                    <div class="perf-card">
                        <div class="number">${data.stats.totalVisits}</div>
                        <div class="label">Total Visits</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${data.stats.instanceVisits}</div>
                        <div class="label">Instance Visits</div>
                    </div>
                `;
            }

            statsHtml += '</div>';

            if (loadTestResults.length > 0) {
                statsHtml += '<h3>‚ö° Recent Load Test Results</h3>';
                statsHtml += displayLoadTestSummary();
            }

            document.getElementById('stats').innerHTML = statsHtml;
        }

        function displayDetailedStats(data) {
            let statsHtml = `
                <h3>üìä Detailed Statistics</h3>
                <div class="performance-stats">
                    <div class="perf-card">
                        <div class="number">Instance ${data.instanceId}</div>
                        <div class="label">Current Instance</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${data.localRequests}</div>
                        <div class="label">Local Requests</div>
                    </div>
            `;

            if (data.global) {
                statsHtml += `
                    <div class="perf-card">
                        <div class="number">${data.global.totalVisits}</div>
                        <div class="label">Total Visits</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${data.global.instance1Visits}</div>
                        <div class="label">Instance 1 Visits</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${data.global.instance2Visits}</div>
                        <div class="label">Instance 2 Visits</div>
                    </div>
                `;
            }

            statsHtml += '</div>';

            if (loadTestResults.length > 0) {
                statsHtml += '<h3>‚ö° Load Test History</h3>';
                statsHtml += displayLoadTestSummary();
            }

            document.getElementById('stats').innerHTML = statsHtml;
        }

        function displayLoadTestResults() {
            const latest = loadTestResults[loadTestResults.length - 1];
            let resultsHtml = `
                <h3>‚ö° Latest Load Test Result</h3>
                <div class="performance-stats">
                    <div class="perf-card">
                        <div class="number">Instance ${latest.instance}</div>
                        <div class="label">Handled by</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${latest.networkTime}ms</div>
                        <div class="label">Network Time</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${latest.processingTime}ms</div>
                        <div class="label">Processing Time</div>
                    </div>
                </div>
            `;

            if (loadTestResults.length > 1) {
                resultsHtml += displayLoadTestSummary();
            }

            document.getElementById('stats').innerHTML = resultsHtml;
        }

        function displayLoadTestSummary() {
            const instance1Tests = loadTestResults.filter(r => r.instance === '1');
            const instance2Tests = loadTestResults.filter(r => r.instance === '2');
            
            const avgProcessing1 = instance1Tests.length > 0 ? 
                Math.round(instance1Tests.reduce((sum, t) => sum + t.processingTime, 0) / instance1Tests.length) : 0;
            const avgProcessing2 = instance2Tests.length > 0 ? 
                Math.round(instance2Tests.reduce((sum, t) => sum + t.processingTime, 0) / instance2Tests.length) : 0;

            return `
                <div class="performance-stats">
                    <div class="perf-card">
                        <div class="number">${loadTestResults.length}</div>
                        <div class="label">Total Tests</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${instance1Tests.length}</div>
                        <div class="label">Instance 1 Hits</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${instance2Tests.length}</div>
                        <div class="label">Instance 2 Hits</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${avgProcessing1}ms</div>
                        <div class="label">Avg Time Instance 1</div>
                    </div>
                    <div class="perf-card">
                        <div class="number">${avgProcessing2}ms</div>
                        <div class="label">Avg Time Instance 2</div>
                    </div>
                </div>
            `;
        }

        // Load initial data when page loads
        window.onload = fetchData;

        // Auto refresh every 30 seconds
        setInterval(fetchData, 30000);
    </script>
</body>
</html>